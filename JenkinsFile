pipeline {
  agent any
  options { timestamps() }
  stages {
    stage('Checkout') { steps { checkout scm } }
    stage('Select Maven') {
      steps {
        script {
          if (fileExists('mvnw')) {
            env.MAVEN_CMD = './mvnw'
            echo "Using Maven Wrapper (mvnw) from repo"
          } else {
            echo "No mvnw found. Trying Jenkins Maven tool 'm3'..."
            def mvnHome = tool name: 'm3', type: 'maven'   // doit matcher le nom d√©fini dans Jenkins
            env.PATH = "${mvnHome}/bin:${env.PATH}"
            env.MAVEN_CMD = 'mvn'
            echo "Using Jenkins Maven tool at: ${mvnHome}"
          }
        }
        sh '${MAVEN_CMD} -v'
      }
    }
    stage('Build & Test (package)') {
      steps {
        sh '${MAVEN_CMD} -B -DskipTests=false clean package'
      }
    }
  }
  post {
    always {
      junit 'target/surefire-reports/*.xml'
      archiveArtifacts artifacts: 'target/*.jar', onlyIfSuccessful: true, allowEmptyArchive: true
    }
  }
}
