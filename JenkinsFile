pipeline {
  agent any
  options { timestamps() }

  stages {
    stage('Checkout') { steps { checkout scm } }

    stage('Select Maven') {
      steps {
        script {
          if (fileExists('mvnw')) {
            env.MAVEN_CMD = './mvnw'
            echo "Using Maven Wrapper (mvnw) from repo"
          } else {
            def mvnHome = tool name: 'm3', type: 'maven'
            env.PATH = "${mvnHome}/bin:${env.PATH}"
            env.MAVEN_CMD = 'mvn'
            echo "Using Jenkins Maven tool at: ${mvnHome}"
          }
        }
        sh '${MAVEN_CMD} -v'
      }
    }

    stage('Build & Unit Tests') {
      steps {
        sh '${MAVEN_CMD} -B -DskipTests=false clean verify'
      }
    }

    stage('SonarQube Analysis') {
      steps {
        withSonarQubeEnv('sonarqube') {
          sh '${MAVEN_CMD} -B sonar:sonar -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml'
        }
      }
    }

    stage('Quality Gate') {
      steps {
        timeout(time: 10, unit: 'MINUTES') {
          script {
            def qg = waitForQualityGate()
            if (qg.status != 'OK') {
              error "Quality gate failed: ${qg.status}"
            }
          }
        }
      }
    }

    stage('Package') {
      steps {
        sh '${MAVEN_CMD} -B -DskipTests=false package'
      }
    }

    stage('Deploy to Nexus') {
      steps {
        withCredentials([usernamePassword(credentialsId: 'nexus-creds', usernameVariable: 'NEXUS_USER', passwordVariable: 'NEXUS_PASS')]) {
          writeFile file: 'jenkins-settings.xml', text: """
<settings>
  <servers>
    <server>
      <id>nexus-releases</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
    <server>
      <id>nexus-snapshots</id>
      <username>${NEXUS_USER}</username>
      <password>${NEXUS_PASS}</password>
    </server>
  </servers>
</settings>
"""
          sh '${MAVEN_CMD} -B -s jenkins-settings.xml deploy'
        }
      }
    }
  }

  post {
    always {
      junit '**/target/surefire-reports/*.xml'
      archiveArtifacts artifacts: '**/target/*.jar', onlyIfSuccessful: true, allowEmptyArchive: true
    }
  }
}
